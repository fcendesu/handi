<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laravel Map Test - OpenStreetMap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .coordinate-display {
            font-family: monospace;
            font-size: 11px;
        }
        .map-controls {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 4px;
            font-size: 11px;
        }
        .map-help-text {
            font-size: 13px;
            color: #1e40af;
            background: #dbeafe;
            padding: 8px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow">
        <h1 class="text-2xl font-bold mb-6">Laravel OpenStreetMap Integration Test</h1>
        
        <!-- Coordinate Inputs (matching Laravel implementation) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="latitude" class="block text-sm font-medium text-gray-700 mb-2">
                    Latitude
                </label>
                <input type="number" 
                       name="latitude" 
                       id="latitude" 
                       step="0.00000001"
                       value="35.1856"
                       placeholder="35.1856"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="longitude" class="block text-sm font-medium text-gray-700 mb-2">
                    Longitude
                </label>
                <input type="number" 
                       name="longitude" 
                       id="longitude" 
                       step="0.00000001"
                       value="33.3823"
                       placeholder="33.3823"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <!-- Interactive Map (exact copy from Laravel implementation) -->
        <div class="mt-4">
            <h4 class="text-sm font-medium text-gray-700 mb-2">Interactive Map Location Picker:</h4>
            <div class="map-help-text mb-2">
                üí° Use the map below to visually see the location. Manually enter coordinates above or use "Get Current Location" button for precise positioning.
            </div>
            <div class="border border-gray-300 rounded-lg overflow-hidden bg-gray-100">
                <div id="map-container" class="h-80 relative">
                    <div id="map-loading" class="absolute inset-0 flex items-center justify-center bg-gray-100 z-10">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                            <div class="text-sm text-gray-600">Loading map...</div>
                        </div>
                    </div>
                    <iframe id="location-map" 
                            src=""
                            width="100%" 
                            height="100%" 
                            style="border:0;" 
                            allowfullscreen="" 
                            loading="eager"
                            title="Property Location Map"
                            onload="handleMapLoad()"
                            onerror="handleMapError()">
                    </iframe>
                    <div class="absolute top-2 left-2 map-controls p-2 text-xs text-gray-700">
                        <div class="font-medium mb-1">üìç Current Location:</div>
                        <div id="map-coordinates" class="coordinate-display">
                            No coordinates set
                        </div>
                    </div>
                    <div class="absolute bottom-2 right-2 map-controls p-2 text-xs text-gray-600">
                        <div class="text-center">
                            <div class="mb-1">üó∫Ô∏è OpenStreetMap</div>
                            <div>Visual reference only</div>
                        </div>
                    </div>
                    <div id="map-error" class="absolute inset-0 bg-gray-100 items-center justify-center" style="display: none; flex-direction: column;">
                        <div class="text-center p-4">
                            <div class="text-red-600 mb-2">‚ö†Ô∏è Map failed to load</div>
                            <div class="text-xs text-gray-500 mb-3">
                                Please check your internet connection or try again later
                            </div>
                            <div class="space-y-2">
                                <button type="button" onclick="retryMapLoad()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs block mx-auto">
                                    üîÑ Retry Loading
                                </button>
                                <a href="https://maps.google.com" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs underline block">
                                    Open Google Maps instead
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-2 flex flex-wrap gap-2">
                <button type="button" 
                        id="update-map-view"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition duration-200 flex items-center">
                    üìç Center Map on Coordinates
                </button>
                <button type="button" 
                        id="reset-map"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition duration-200 flex items-center">
                    üîÑ Reset View
                </button>
                <a href="https://www.openstreetmap.org" 
                   target="_blank"
                   class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition duration-200 flex items-center">
                    üó∫Ô∏è Open Full Map
                </a>
            </div>
            <div class="mt-2 space-y-2">
                <div class="text-xs text-gray-500 bg-blue-50 p-2 rounded border-l-4 border-blue-400">
                    <strong>üí° How to set location:</strong> Enter coordinates manually in the fields above, use the "Get Current Location" button, or use the map controls below. The map provides visual confirmation of your coordinates.
                </div>
                <div id="map-status" class="text-xs text-gray-600 bg-gray-50 p-2 rounded hidden">
                    <span id="map-status-text">Map ready</span>
                </div>
            </div>
        </div>

        <!-- Get Current Location Button -->
        <div class="mt-4">
            <button type="button" 
                    id="get-current-location"
                    class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-md text-sm transition duration-200">
                Get Current Location
            </button>
            <div id="location-status" class="text-sm hidden"></div>
        </div>
    </div>

    <script>
        // Global helper functions for map loading (exact copy from Laravel)
        function handleMapLoad() {
            console.log('Map loaded successfully');
            setTimeout(() => {
                document.getElementById('map-loading').style.display = 'none';
                showMapStatus('Map loaded successfully', 'success');
            }, 500); // Small delay to ensure map is fully rendered
        }

        function handleMapError() {
            console.log('Map failed to load');
            document.getElementById('map-loading').style.display = 'none';
            const mapError = document.getElementById('map-error');
            mapError.style.display = 'flex';
            showMapStatus('Map failed to load', 'error');
        }

        function showMapStatus(message, type) {
            const status = document.getElementById('map-status');
            const statusText = document.getElementById('map-status-text');
            
            if (status && statusText) {
                statusText.textContent = message;
                status.className = 'text-xs p-2 rounded';
                
                if (type === 'error') {
                    status.className += ' text-red-600 bg-red-50 border border-red-200';
                } else if (type === 'success') {
                    status.className += ' text-green-600 bg-green-50 border border-green-200';
                } else {
                    status.className += ' text-blue-600 bg-blue-50 border border-blue-200';
                }
                
                status.style.display = 'block';
                
                // Auto-hide success messages
                if (type === 'success') {
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 3000);
                }
            }
        }

        function retryMapLoad() {
            console.log('Retrying map load');
            document.getElementById('map-error').style.display = 'none';
            document.getElementById('map-loading').style.display = 'flex';
            
            // Clear the iframe src first
            const mapFrame = document.getElementById('location-map');
            mapFrame.src = '';
            
            // Wait a moment then trigger reload
            setTimeout(() => {
                const latitudeInput = document.getElementById('latitude');
                const longitudeInput = document.getElementById('longitude');
                
                if (latitudeInput.value && longitudeInput.value) {
                    window.updateMapView();
                } else {
                    window.resetMapView();
                }
            }, 100);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            const latitudeInput = document.getElementById('latitude');
            const longitudeInput = document.getElementById('longitude');
            const mapFrame = document.getElementById('location-map');
            const mapCoordinates = document.getElementById('map-coordinates');
            const updateMapButton = document.getElementById('update-map-view');
            const resetMapButton = document.getElementById('reset-map');
            const locationButton = document.getElementById('get-current-location');
            const locationStatus = document.getElementById('location-status');

            let currentLat = 35.1856;  // Default Cyprus coordinates
            let currentLng = 33.3823;

            // Update map display
            window.updateMapView = function() {
                const lat = parseFloat(latitudeInput.value) || currentLat;
                const lng = parseFloat(longitudeInput.value) || currentLng;
                
                console.log('Updating map view with coordinates:', lat, lng);
                showMapStatus('Loading map...', 'info');
                
                // Validate coordinates
                if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    console.error('Invalid coordinates:', lat, lng);
                    showMapStatus('Invalid coordinates provided', 'error');
                    handleMapError();
                    return;
                }
                
                // Calculate bounding box (roughly 2km x 2km area)
                const offset = 0.01;
                const bbox = `${lng - offset},${lat - offset},${lng + offset},${lat + offset}`;
                
                const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat},${lng}`;
                console.log('Map URL:', mapUrl);
                
                // Show loading indicator
                document.getElementById('map-loading').style.display = 'flex';
                document.getElementById('map-error').style.display = 'none';
                
                // Set a timeout for the map loading
                setTimeout(() => {
                    if (document.getElementById('map-loading').style.display !== 'none') {
                        console.warn('Map taking too long to load, showing error');
                        showMapStatus('Map loading timeout - please check your connection', 'error');
                        handleMapError();
                    }
                }, 10000); // 10 second timeout
                
                mapFrame.src = mapUrl;
                
                updateCoordinateDisplay(lat, lng);
                currentLat = lat;
                currentLng = lng;
            }

            // Update coordinate display
            function updateCoordinateDisplay(lat, lng) {
                if (lat && lng && lat !== 0 && lng !== 0) {
                    mapCoordinates.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    mapCoordinates.className = 'coordinate-display';
                } else {
                    mapCoordinates.textContent = 'No coordinates set';
                    mapCoordinates.className = 'coordinate-display text-gray-400';
                }
            }

            // Reset map to default view
            window.resetMapView = function() {
                console.log('Resetting map view');
                showMapStatus('Loading default map view...', 'info');
                
                const defaultBbox = "32.5,35.0,34.5,37.0"; // Cyprus/Turkey region
                const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${defaultBbox}&layer=mapnik`;
                console.log('Reset map URL:', mapUrl);
                
                // Show loading indicator
                document.getElementById('map-loading').style.display = 'flex';
                document.getElementById('map-error').style.display = 'none';
                
                // Set a timeout for the map loading
                setTimeout(() => {
                    if (document.getElementById('map-loading').style.display !== 'none') {
                        console.warn('Map reset taking too long to load, showing error');
                        showMapStatus('Map loading timeout - please check your connection', 'error');
                        handleMapError();
                    }
                }, 10000); // 10 second timeout
                
                mapFrame.src = mapUrl;
                mapCoordinates.textContent = "No coordinates set";
                mapCoordinates.className = 'coordinate-display text-gray-400';
            }

            // Map control buttons
            updateMapButton.addEventListener('click', function() {
                window.updateMapView();
                showLocationStatus('Map centered on current coordinates', 'info');
            });

            resetMapButton.addEventListener('click', function() {
                window.resetMapView();
                showLocationStatus('Map view reset', 'info');
            });

            // Update map when coordinates change manually
            latitudeInput.addEventListener('change', function() {
                if (this.value) {
                    window.updateMapView();
                }
            });

            longitudeInput.addEventListener('change', function() {
                if (this.value) {
                    window.updateMapView();
                }
            });

            // Initialize map view with delay to ensure DOM is ready
            console.log('Initializing map with coordinates:', latitudeInput.value, longitudeInput.value);
            
            setTimeout(() => {
                if (latitudeInput.value && longitudeInput.value && latitudeInput.value !== '' && longitudeInput.value !== '') {
                    console.log('Using existing coordinates for map initialization');
                    window.updateMapView();
                } else {
                    console.log('No coordinates found, using default view for map initialization');
                    window.resetMapView();
                }
            }, 100); // Small delay to ensure iframe is ready

            // Geolocation functionality
            locationButton.addEventListener('click', function() {
                if (!navigator.geolocation) {
                    showLocationStatus('Geolocation is not supported by this browser.', 'error');
                    return;
                }

                locationButton.textContent = 'Getting location...';
                locationButton.disabled = true;
                showLocationStatus('Getting your current location...', 'info');

                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        latitudeInput.value = position.coords.latitude.toFixed(8);
                        longitudeInput.value = position.coords.longitude.toFixed(8);
                        
                        // Update map view with new coordinates
                        window.updateMapView();
                        
                        locationButton.textContent = 'Location Obtained!';
                        showLocationStatus('Location successfully obtained and map updated!', 'success');
                        
                        setTimeout(function() {
                            locationButton.textContent = 'Get Current Location';
                            locationButton.disabled = false;
                            hideLocationStatus();
                        }, 3000);
                    },
                    function(error) {
                        let errorMessage;
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Location access denied by user.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Location information is unavailable.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Location request timed out.';
                                break;
                            default:
                                errorMessage = 'An unknown error occurred while getting location.';
                                break;
                        }
                        
                        showLocationStatus(errorMessage, 'error');
                        locationButton.textContent = 'Get Current Location';
                        locationButton.disabled = false;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            });

            function showLocationStatus(message, type) {
                locationStatus.textContent = message;
                locationStatus.className = 'text-sm block mt-2';
                
                if (type === 'error') {
                    locationStatus.classList.add('text-red-600');
                } else if (type === 'success') {
                    locationStatus.classList.add('text-green-600');
                } else {
                    locationStatus.classList.add('text-blue-600');
                }

                // Auto-hide info and success messages after 3 seconds
                if (type !== 'error') {
                    setTimeout(hideLocationStatus, 3000);
                }
            }

            function hideLocationStatus() {
                locationStatus.className = 'text-sm hidden';
                locationStatus.textContent = '';
            }
        });
    </script>
</body>
</html>
